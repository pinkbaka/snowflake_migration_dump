///CLEANUP 2020 tables

DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2020_GRP";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2020_UNPIVOT";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2";




// 2020

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2020_GRP"
as(


SELECT date_trunc('QUARTER', closedate) as CLOSE_QUARTER, OWNERID, OPP_OWNERNAME__SNW,OPPORTUNITY_OWNER_ROLE__C, 
  SUM(SALES_CREDIT_ARR__C) as QUOTA_RELIEF,
  SUM(CASE WHEN TYPE = 'New Business' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(CASE WHEN TYPE = 'Upsell' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_UPSELL,
  SUM(CASE WHEN TYPE = 'Renewal' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_RENEWAL
--date_trunc('MONTH', closedate)
FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
WHERE STAGENAME = 'Closed Won'
AND TYPE in ('New Business', 'Upsell', 'Renewal')
and closedate >= '1/1/2020'
and CLOSEDATE <= '12/31/2020'
and (OPPORTUNITY_OWNER_ROLE__C like '%AE%' or OPPORTUNITY_OWNER_ROLE__C like '%AM%' or OPPORTUNITY_OWNER_ROLE__C is null)
group by 1,2,3,4
order by  OPPORTUNITY_OWNER_ROLE__C, OWNERID,CLOSE_QUARTER
--SUM(SALES_CREDIT_ARR__C) desc
  );


//SELECT *,ANNUAL_QUOTA_MAX FROM"MTL_LOAD_PRE"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS";



CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2020_UNPIVOT"
as(
SELECT NAME,SF_ID, ROLE, 
  
  
  CASE WHEN SEGMENT like '%CE%' THEN 'EE'
        WHEN SEGMENT LIKE '%EC%' THEN 'EC'
        ELSE SEGMENT END AS SEGMENT, 
  
  QUARTER, QUOTA,
    case when QUARTER = 'Q1' then '2020-01-01'
        when QUARTER = 'Q2' then '2020-04-01'
        when QUARTER = 'Q3' then '2020-07-01'
        else  '2020-10-01'
        end as CLOSE_QUARTER
FROM (SELECT NAME,SF_ID, Q1, Q2,Q3,Q4, ROLE, SEGMENT 
      FROM "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
    wHERE YEAR = 2020)
unpivot(QUOTA for QUARTER in (Q1, Q2,Q3,Q4))
);

//SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2020_UNPIVOT";


SELECT  * 
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2020_UNPIVOT" t1
FULL JOIN  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2020_GRP" t2
on t1.SF_ID = t2.OWNERID
    AND t1.CLOSE_QUARTER = t2.CLOSE_QUARTER;







CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL"
AS
(
SELECT  NAME, SF_ID, ROLE, SEGMENT, QUARTER, QUOTA, t1.CLOSE_QUARTER,
OWNERID,-- OPP_OWNERNAME__SNW,
QUOTA_RELIEF,
 QUOTA_RELIEF_NEW_BUSINESS,
QUOTA_RELIEF_UPSELL,
QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2020_UNPIVOT" t1
FULL JOIN  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2020_GRP" t2
on t1.SF_ID = t2.OWNERID
    AND t1.CLOSE_QUARTER = t2.CLOSE_QUARTER
);

SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL";

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER,
OWNERID, SUM(QUOTA) as QUOTA,
SUM(IFNULL(QUOTA_RELIEF,0)) as QUOTA_RELIEF,
  SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS,
SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL,
SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL,
 DIV0(SUM(IFNULL(QUOTA_RELIEF,0)),SUM(QUOTA)) as productivity
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL"
GROUP BY NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER, OWNERID
order by segment, role, name
  );
  
SELECT * 
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2"
ORDER BY NAME, CLOSE_QUARTER ASC;
