SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_FINANCE_QUOTA_RELIEF_PRE";

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_FINANCE_QUOTA_RELIEF"
as(
SELECT "Opportunity IDs" as SF_ID,
"Closed Date" as "CLOSED DATE",
"Opportunity Owner" as "OPPORTUNITY OWNER",
"Type" as "TYPE",
"Opportunity Name" as "OPPORTUNITY NAME",
"Sales Credit" as "SALES CREDIT",
"Quota Relief" as "QUOTA RELIEF",
"Amount" as "AMOUNT",
"Net ARR" as "NET ARR",
"Expiring ARR" as "EXPIRING ARR"

FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_FINANCE_QUOTA_RELIEF_PRE"
);
//2021 CQ's

///CLEANUP CQ tables
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_CQ_GRP";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL2";


CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_CQ_GRP"
as(


SELECT date_trunc('QUARTER', closedate) as CLOSE_QUARTER, OWNERID, OPP_OWNERNAME__SNW,OPPORTUNITY_OWNER_ROLE__C, 
  SUM(SALES_CREDIT_ARR__C) as QUOTA_RELIEF,
  SUM(CASE WHEN TYPE = 'New Business' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(CASE WHEN TYPE = 'Upsell' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_UPSELL,
  SUM(CASE WHEN TYPE = 'Renewal' THEN SALES_CREDIT_ARR__C else 0.0 END) as QUOTA_RELIEF_RENEWAL
--date_trunc('MONTH', closedate)
FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
WHERE STAGENAME = 'Closed Won'
AND TYPE in ('New Business', 'Upsell', 'Renewal')
and closedate >= '9/1/2021'
and CLOSEDATE <= '9/30/2021'
and (OPPORTUNITY_OWNER_ROLE__C like '%AE%' or OPPORTUNITY_OWNER_ROLE__C like '%AM%' or OPPORTUNITY_OWNER_ROLE__C is null)
group by 1,2,3,4
order by  OPPORTUNITY_OWNER_ROLE__C, OWNERID,CLOSE_QUARTER
--SUM(SALES_CREDIT_ARR__C) desc
  );


// JOIN QUOTA AND FULLFILLMENT
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL" AS (
  SELECT  NAME, SF_ID, ROLE, SEGMENT, QUARTER, QUOTA, t1.CLOSE_QUARTER,
  OWNERID,-- OPP_OWNERNAME__SNW,
  QUOTA_RELIEF,
    QUOTA_RELIEF_NEW_BUSINESS,
    QUOTA_RELIEF_UPSELL,
    QUOTA_RELIEF_RENEWAL
  FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT" t1
  FULL JOIN  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_CQ_GRP" t2
  on t1.SF_ID = t2.OWNERID
      AND t1.CLOSE_QUARTER = t2.CLOSE_QUARTER
  WHERE 
  QUARTER  in ('Q3')
  AND (QUOTA > 0)
  order by segment, namE
);
SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL";
//CALCULATE PRODUCTIVITY

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL2"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER,
OWNERID, SUM(QUOTA) as QUOTA,
SUM(IFNULL(QUOTA_RELIEF,0)) as QUOTA_RELIEF,
SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS,
SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL,
SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL,
 DIV0(SUM(IFNULL(QUOTA_RELIEF,0)),SUM(QUOTA)) as productivity
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL"
GROUP BY NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER, OWNERID
order by segment, role, name
);

//2021 PQ's

///CLEANUP 2021 tables
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021_GRP";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL";
DROP TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2";

// SUM QUOTA RELIEF BASED ON FINANCE DATA FOR 2021
// ADJUST OWNER ID's FOR USERS WHO CHANGED

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021"
as(
SELECT
ID,
closedate,
CASE
  -- ADJUST FOR MOLLY OFLAHERTY
  WHEN oppowner = '0055A000008NWBzQAO' THEN '0055A00000Apg1PQAR' 
  --KEVIN KIM
  WHEN oppowner = '0055A000008NUz4QAG' THEN '0056e00000AgQnRAAV'
  ELSE oppowner 
  END  as OWNERID,
type,
case when OPPORTUNITY_OWNER_ROLE__C = 'Team Lead - AM Sales' then 'AM - Commercial Sales' else OPPORTUNITY_OWNER_ROLE__C end as OPPORTUNITY_OWNER_ROLE__C,
ownername,
--OPPORTUNITY_OWNER_ROLE__C,
OPPORTUNITY_NAME,
SUM(SALES_CREDIT) AS SUM_SALES_CREDIT,
sum(X2021_Sales_Credit_Deferred__c) SUM_SALES_CREDIT_DEFERRED,
SUM(QUOTA_RELIEF) SUM_QUOTA_RELIEF,
SUM(CASE WHEN TYPE = 'New Business' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(CASE WHEN TYPE = 'Upsell' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_UPSELL,
  SUM(CASE WHEN TYPE = 'Renewal' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_RENEWAL,
SUM(SALES_CREDIT) +sum(ifnull(X2021_Sales_Credit_Deferred__c,0)) AS expected_relief,
SUM(SALES_CREDIT) +sum(ifnull(X2021_Sales_Credit_Deferred__c,0)) - SUM(QUOTA_RELIEF) as DELTA
FROM
(
SELECT
t2.ID,
OWNERID as oppowner,
  X2021_Sales_Credit_Deferred__c,
OPP_OWNERNAME__SNW as ownername,
  OPPORTUNITY_OWNER_ROLE__C,
  "OPPORTUNITY NAME" AS OPPORTUNITY_NAME,
  "SALES CREDIT" as SALES_CREDIT,
"QUOTA RELIEF" as QUOTA_RELIEF,
  closedate,
  t1.type
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_FINANCE_QUOTA_RELIEF" t1
LEFT JOIN "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY" t2
on t1.SF_ID = t2.ID
where closedate >= '1/1/2021'
  and closedate <= '9/30/2021'
)
WHERE OPPORTUNITY_OWNER_ROLE__C not in ('CS Operations','CSM')
GROUP BY 1,2,3,4,5,6,7
order by 3
); 


//SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021";


//GROUP on OWNER
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021_GRP"
as(
SELECT date_trunc('QUARTER', closedate) as CLOSE_QUARTER, OWNERID, ownername as OPP_OWNERNAME__SNW,OPPORTUNITY_OWNER_ROLE__C, 
  SUM(SUM_QUOTA_RELIEF) as QUOTA_RELIEF,
  SUM(QUOTA_RELIEF_NEW_BUSINESS) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(QUOTA_RELIEF_UPSELL) as QUOTA_RELIEF_UPSELL,
  SUM(QUOTA_RELIEF_RENEWAL) as QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021"
GROUP BY 1,2,3,4
  );


//UNPIVOT QUOTA DATA
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT"
as(
SELECT NAME,SF_ID, ROLE, SEGMENT, QUARTER, QUOTA,
    case when QUARTER = 'Q1' then '2021-01-01'
        when QUARTER = 'Q2' then '2021-04-01'
        when QUARTER = 'Q3' then '2021-07-01'
        else  '2021-10-01'
        end as CLOSE_QUARTER
FROM (SELECT NAME,SF_ID, IFNULL(Q1,0) as Q1, IFNULL(Q2,0) as Q2,IFNULL(Q3,0) as Q3,IFNULL(Q4,0) as Q4, ROLE, SEGMENT 
      FROM "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
    wHERE YEAR = 2021
    and segment is not null)
unpivot(QUOTA for QUARTER in (Q1, Q2,Q3,Q4))
);



// JOIN QUOTA AND FULLFILLMENT
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL"
AS
(
SELECT  NAME, SF_ID, ROLE, SEGMENT, QUARTER, QUOTA, t1.CLOSE_QUARTER,
OWNERID,-- OPP_OWNERNAME__SNW,
QUOTA_RELIEF,
  QUOTA_RELIEF_NEW_BUSINESS,
  QUOTA_RELIEF_UPSELL,
  QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT" t1
FULL JOIN  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021_GRP" t2
on t1.SF_ID = t2.OWNERID
    AND t1.CLOSE_QUARTER = t2.CLOSE_QUARTER
WHERE 
QUARTER not in ('Q4')
AND (QUOTA > 0)
order by segment, namE);

//CALCULATE PRODUCTIVITY

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER,
OWNERID, SUM(QUOTA) as QUOTA,
SUM(IFNULL(QUOTA_RELIEF,0)) as QUOTA_RELIEF,
SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS,
SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL,
SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL,
 DIV0(SUM(IFNULL(QUOTA_RELIEF,0)),SUM(QUOTA)) as productivity
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL"
GROUP BY NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER, OWNERID
order by segment, role, name
);

//--??
//CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1"
//as
//(
//
//(SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2")
//UNION
//(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
//    
//);


CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST2"
AS 
(
  SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2"
);




CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST"
as
(
(SELECT *, 'CQ by Salescredit' as CALC_DESCRIPTION FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_CQ_ATTAINMENT_FNL2")
UNION
(SELECT *, 'CY by FINANCE ATTAINMENT' as CALC_DESCRIPTION FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
);

CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST"
AS 
(
  SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST"
);


CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST2"
AS 
(
SELECT NAME, SF_ID, ROLE, SEGMENT, QUARTER, CLOSE_QUARTER, 
AVG(QUOTA) as QUOTA,
SUM(QUOTA_RELIEF) AS QUOTA_RELIEF, 

SUM(QUOTA_RELIEF_NEW_BUSINESS) AS QUOTA_RELIEF_NEW_BUSINESS, 
SUM(QUOTA_RELIEF_UPSELL) AS QUOTA_RELIEF_UPSELL, 
SUM(QUOTA_RELIEF_RENEWAL) AS QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST"
GROUP BY 1,2,3,4,5,6
);

//CREEATE ADDITIONALL DELETES

--??
CREATE OR REPLACE TABLE "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS"
AS 
(SELECT DATE(CLOSE_QUARTER) as CLOSE_PERIOD, * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1" t1
  LEFT JOIN "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_SNOWFLAKE_AE_FQBR_DATA" t2
    ON t1.SEGMENT = t2.CURRENTSEG_ABRV
      AND YEAR(DATE(CLOSE_QUARTER)) = t2."FISCAL YEAR"
      AND QUARTER(DATE(CLOSE_QUARTER)) = t2."FISCAL QUARTER");

SELECT * FROM "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS";



CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT
        ,MIN(NULL) as QUARTER
        ,MIN(NULL) as CLOSE_QUARTER
        ,MIN(SF_ID) as OWNERID
        ,SUM(QUOTA) as QUOTA
        ,SUM(QUOTA_RELIEF) as QUOTA_RELIEF
        ,SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS
        ,SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL
        ,SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL
        ,SUM(QUOTA_RELIEF)/SUM(QUOTA) as PRODUCTIVTY
  FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2" t1
  GROUP BY NAME, SF_ID, ROLE, SEGMENT--,QUARTER, CLOSE_QUARTER, OWNERID
);


CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(

(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
UNION
(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3")
    
);

CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(
  SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
);




CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST" as (
    SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_EST"
);



SELECT closedate as close_date, SALES_CREDIT_ARR__C as sc, * FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
WHERE OWNERID = '0055A000008NVIfQAO'
AND STAGENAME = 'Closed Won'
order by closedate desc


///?TEST


// SUM QUOTA RELIEF BASED ON FINANCE DATA FOR 2021
// ADJUST OWNER ID's FOR USERS WHO CHANGED

///?TEST
// SUM QUOTA RELIEF BASED ON FINANCE DATA FOR 2021
// ADJUST OWNER ID's FOR USERS WHO CHANGED


--??
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1"
as
(

(SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2")
UNION
(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
    
);


--??
CREATE OR REPLACE TABLE "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS"
AS 
(SELECT DATE(CLOSE_QUARTER) as CLOSE_PERIOD, * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1" t1
  LEFT JOIN "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_SNOWFLAKE_AE_FQBR_DATA" t2
    ON t1.SEGMENT = t2.CURRENTSEG_ABRV
      AND YEAR(DATE(CLOSE_QUARTER)) = t2."FISCAL YEAR"
      AND QUARTER(DATE(CLOSE_QUARTER)) = t2."FISCAL QUARTER");

SELECT * FROM "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS";



CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT
        ,MIN(NULL) as QUARTER
        ,MIN(NULL) as CLOSE_QUARTER
        ,MIN(SF_ID) as OWNERID
        ,SUM(QUOTA) as QUOTA
        ,SUM(QUOTA_RELIEF) as QUOTA_RELIEF
        ,SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS
        ,SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL
        ,SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL
        ,SUM(QUOTA_RELIEF)/SUM(QUOTA) as PRODUCTIVTY
  FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2" t1
  GROUP BY NAME, SF_ID, ROLE, SEGMENT--,QUARTER, CLOSE_QUARTER, OWNERID
);


CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(

(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
UNION
(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3")
    
);

CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(
  SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
);

SELECT closedate as close_date, SALES_CREDIT_ARR__C as sc, * FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
WHERE OWNERID = '0055A000008NVIfQAO'
AND STAGENAME = 'Closed Won'
order by closedate desc


///?TEST


// SUM QUOTA RELIEF BASED ON FINANCE DATA FOR 2021
// ADJUST OWNER ID's FOR USERS WHO CHANGED

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021"
as(
SELECT
ID,
closedate,
CASE
  -- ADJUST FOR MOLLY OFLAHERTY
  WHEN oppowner = '0055A000008NWBzQAO' THEN '0055A00000Apg1PQAR' 
  --KEVIN KIM
  WHEN oppowner = '0055A000008NUz4QAG' THEN '0056e00000AgQnRAAV'
  ELSE oppowner 
  END  as OWNERID,
type,
case when OPPORTUNITY_OWNER_ROLE__C = 'Team Lead - AM Sales' then 'AM - Commercial Sales' else OPPORTUNITY_OWNER_ROLE__C end as OPPORTUNITY_OWNER_ROLE__C,
ownername,
--OPPORTUNITY_OWNER_ROLE__C,
OPPORTUNITY_NAME,
SUM(SALES_CREDIT) AS SUM_SALES_CREDIT,
sum(X2021_Sales_Credit_Deferred__c) SUM_SALES_CREDIT_DEFERRED,
SUM(QUOTA_RELIEF) SUM_QUOTA_RELIEF,
SUM(CASE WHEN TYPE = 'New Business' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(CASE WHEN TYPE = 'Upsell' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_UPSELL,
  SUM(CASE WHEN TYPE = 'Renewal' THEN QUOTA_RELIEF else 0.0 END) as QUOTA_RELIEF_RENEWAL,
SUM(SALES_CREDIT) +sum(ifnull(X2021_Sales_Credit_Deferred__c,0)) AS expected_relief,
SUM(SALES_CREDIT) +sum(ifnull(X2021_Sales_Credit_Deferred__c,0)) - SUM(QUOTA_RELIEF) as DELTA
FROM
(
SELECT
t2.ID,
OWNERID as oppowner,
  X2021_Sales_Credit_Deferred__c,
OPP_OWNERNAME__SNW as ownername,
  OPPORTUNITY_OWNER_ROLE__C,
  "OPPORTUNITY NAME" AS OPPORTUNITY_NAME,
  "SALES CREDIT" as SALES_CREDIT,
"QUOTA RELIEF" as QUOTA_RELIEF,
  closedate,
  t1.type
FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_FINANCE_QUOTA_RELIEF" t1
LEFT JOIN "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY" t2
on t1.SF_ID = t2.ID
where closedate >= '1/1/2021'
  and closedate <= '10/1/2021'
)
WHERE OPPORTUNITY_OWNER_ROLE__C not in ('CS Operations','CSM')
GROUP BY 1,2,3,4,5,6,7
order by 3
); 


//SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021";


//GROUP on OWNER
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021_GRP"
as(
SELECT date_trunc('QUARTER', closedate) as CLOSE_QUARTER, OWNERID, ownername as OPP_OWNERNAME__SNW,OPPORTUNITY_OWNER_ROLE__C, 
  SUM(SUM_QUOTA_RELIEF) as QUOTA_RELIEF,
  SUM(QUOTA_RELIEF_NEW_BUSINESS) as QUOTA_RELIEF_NEW_BUSINESS,
  SUM(QUOTA_RELIEF_UPSELL) as QUOTA_RELIEF_UPSELL,
  SUM(QUOTA_RELIEF_RENEWAL) as QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021"
GROUP BY 1,2,3,4
  );


//UNPIVOT QUOTA DATA
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT"
as(
SELECT NAME,SF_ID, ROLE, SEGMENT, QUARTER, QUOTA,
    case when QUARTER = 'Q1' then '2021-01-01'
        when QUARTER = 'Q2' then '2021-04-01'
        when QUARTER = 'Q3' then '2021-07-01'
        else  '2021-10-01'
        end as CLOSE_QUARTER
FROM (SELECT NAME,SF_ID, IFNULL(Q1,0) as Q1, IFNULL(Q2,0) as Q2,IFNULL(Q3,0) as Q3,IFNULL(Q4,0) as Q4, ROLE, SEGMENT 
      FROM "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
    wHERE YEAR = 2021
    and segment is not null)
unpivot(QUOTA for QUARTER in (Q1, Q2,Q3,Q4))
);



// JOIN QUOTA AND FULLFILLMENT
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL"
AS
(
SELECT  NAME, SF_ID, ROLE, SEGMENT, QUARTER, QUOTA, t1.CLOSE_QUARTER,
OWNERID,-- OPP_OWNERNAME__SNW,
QUOTA_RELIEF,
  QUOTA_RELIEF_NEW_BUSINESS,
  QUOTA_RELIEF_UPSELL,
  QUOTA_RELIEF_RENEWAL
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_QUOTA_2021_UNPIVOT" t1
FULL JOIN  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_ATTAINMENT_2021_GRP" t2
on t1.SF_ID = t2.OWNERID
    AND t1.CLOSE_QUARTER = t2.CLOSE_QUARTER
WHERE 
QUARTER not in ('Q4')
AND (QUOTA > 0)
order by segment, namE);

//CALCULATE PRODUCTIVITY

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER,
OWNERID, SUM(QUOTA) as QUOTA,
SUM(IFNULL(QUOTA_RELIEF,0)) as QUOTA_RELIEF,
SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS,
SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL,
SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL,
 DIV0(SUM(IFNULL(QUOTA_RELIEF,0)),SUM(QUOTA)) as productivity
FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL"
GROUP BY NAME, SF_ID, ROLE, SEGMENT, QUARTER,  CLOSE_QUARTER, OWNERID
order by segment, role, name
);

--??
CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1"
as
(

(SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2020_ATTAINMENT_FNL2")
UNION
(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
    
);


--??
CREATE OR REPLACE TABLE "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS"
AS 
(SELECT DATE(CLOSE_QUARTER) as CLOSE_PERIOD, * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_V1" t1
  LEFT JOIN "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_SNOWFLAKE_AE_FQBR_DATA" t2
    ON t1.SEGMENT = t2.CURRENTSEG_ABRV
      AND YEAR(DATE(CLOSE_QUARTER)) = t2."FISCAL YEAR"
      AND QUARTER(DATE(CLOSE_QUARTER)) = t2."FISCAL QUARTER");

SELECT * FROM "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS";



CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3"
AS
(
SELECT NAME, SF_ID, ROLE, SEGMENT
        ,MIN(NULL) as QUARTER
        ,MIN(NULL) as CLOSE_QUARTER
        ,MIN(SF_ID) as OWNERID
        ,SUM(QUOTA) as QUOTA
        ,SUM(QUOTA_RELIEF) as QUOTA_RELIEF
        ,SUM(IFNULL(QUOTA_RELIEF_NEW_BUSINESS,0)) as QUOTA_RELIEF_NEW_BUSINESS
        ,SUM(IFNULL(QUOTA_RELIEF_UPSELL,0)) as QUOTA_RELIEF_UPSELL
        ,SUM(IFNULL(QUOTA_RELIEF_RENEWAL,0)) as QUOTA_RELIEF_RENEWAL
        ,SUM(QUOTA_RELIEF)/SUM(QUOTA) as PRODUCTIVTY
  FROM "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2" t1
  GROUP BY NAME, SF_ID, ROLE, SEGMENT--,QUARTER, CLOSE_QUARTER, OWNERID
);


CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(

(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL2")
UNION
(SELECT * FROM  "MTL_LOAD_TEST"."PUBLIC"."TARGET_AE_2021_ATTAINMENT_FNL3")
    
);

CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
as
(
  SELECT * FROM "MTL_LOAD_TEST"."PUBLIC"."AE_PRODUCTIVITY_ANALYSIS_SPA"
);

SELECT closedate as close_date, SALES_CREDIT_ARR__C as sc, * FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
WHERE OWNERID = '0055A000008NVIfQAO'
AND STAGENAME = 'Closed Won'
order by closedate desc;

 
SELECT  t2.NAME,t1.NAME FROM "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_USER" t1
LEFT JOIN "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_USERROLE" t2
on t1.USERROLEID = t2.id
where ISACTIVE
and UPPER(t2.NAME) like '%SDR%'
order by 1,2;
