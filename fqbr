CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."SNW_FQBR_SALESCREDIT_BASE"
AS
(
  SELECT 
      BEST_ACCTSEGMENT_AT_CLOSE__SNW,
      TYPE,
      YEAR(closedate) as CLOSE_YEAR,
      QUARTER(closedate) as CLOSE_QUARTER,
      SUM(SALES_CREDIT_ARR__C) as SALESCREDIT
  FROM
  (
    SELECT BEST_ACCTSEGMENT_AT_CLOSE__SNW,closedate, SALES_CREDIT_ARR__C,
      type , stagename, 
      name,  OPP_OWNERNAME__SNW,OPPORTUNITY_OWNER_ROLE__C
    FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_OPPORTUNITY"
    WHERE
      closedate >= '1/1/2020'
      and stagename = 'Closed Won'
      and type in ('New Business','Upsell','Renewal')
      and SALES_CREDIT_ARR__C > 0
      and (OPPORTUNITY_OWNER_ROLE__C like '%AM%' or OPPORTUNITY_OWNER_ROLE__C like '%AE%')
    order by SALES_CREDIT_ARR__C
  )
  group by 1,2,3,4
  order by 1,2,3,4
);

CREATE OR REPLACE VIEW "TABLEAU_REPORTING"."PUBLIC"."SNW_FQBR_DATA"
AS
(
  SELECT *,
    CASE WHEN BEST_ACCTSEGMENT_AT_CLOSE__SNW in ('EC','MM')
        AND TYPE = 'Renewal' then TRUE else FALSE end as AM_CREDIT
  FROM "TABLEAU_REPORTING"."PUBLIC"."SNW_FQBR_SALESCREDIT_BASE" t1
  LEFT JOIN "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_SNOWFLAKE_AE_FQBR_DATA" t2
    ON t1.BEST_ACCTSEGMENT_AT_CLOSE__SNW = t2.CURRENTSEG_ABRV
      AND t1.CLOSE_YEAR = t2."FISCAL YEAR"
      AND t1.CLOSE_QUARTER = t2."FISCAL QUARTER"
);

SELECT * FROM "MTL_LOAD_PRE"."PUBLIC"."TARGET_SNOWFLAKE_AE_FQBR_DATA";
