
set CY = '2021';
set CQ = 'Q4';
set NQ = 'Q4';
set first_month = 'M7';
set second_month = 'M8';
set third_month = 'M9';

// TEST

CREATE OR REPLACE TABLE "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
AS
(
  
  SELECT * 
  FROM  "MTL_LOAD_PRE"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
  WHERE  YEAR = '2021' 
    AND  ACTIVE = TRUE
    
);

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST"
AS
(
SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY,NAME
FROM
(
SELECT * FROM
    
    (
    SELECT NAME, '1' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_quota' as QUOTA_NAME, QUOTA_GOAL, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in (Q1, Q2, Q3, Q4))
    WHERE PERIOD_NAME in ($CQ)
    )
UNION
    (
    SELECT NAME, '2' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_nq_quota' as QUOTA_NAME, QUOTA_GOAL, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in (Q1, Q2, Q3, Q4))
    WHERE PERIOD_NAME in ($NQ)
    )
UNION
    (
    SELECT NAME, '3' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_month_quota' as QUOTA_NAME, QUOTA_GOAL Quota_Goal, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in ( M1, M2, M3, M4, M5, M6, M7, M8, M9, M10, M11, M12 ))
    WHERE PERIOD_NAME IN ($first_month, $second_month, $third_month)
    )
  
ORDER BY NAME, ROW_ORDER, PERIOD_NAME)
) 
  ;
  
  
  SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY--,NAME
  FROM "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST";



set CY = '2021';
set CQ = 'Q4';
set first_month = 'M10';
set second_month = 'M11';
set third_month = 'M12';

// TEST

CREATE OR REPLACE TABLE "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
AS
(
  
  SELECT * 
  FROM  "MTL_LOAD_PRE"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
  WHERE  YEAR = '2021' 
    AND  ACTIVE = TRUE
    
);

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST"
AS
(
SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY,NAME
FROM
(
SELECT * FROM
    
    (
    SELECT NAME, '1' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_quota' as QUOTA_NAME, QUOTA_GOAL, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in (Q1, Q2, Q3, Q4))
    WHERE PERIOD_NAME in ($CQ)
    )
UNION
    (
    SELECT NAME, '3' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_month_quota' as QUOTA_NAME, QUOTA_GOAL Quota_Goal, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in ( M1, M2, M3, M4, M5, M6, M7, M8, M9, M10, M11, M12 ))
    WHERE PERIOD_NAME IN ($first_month, $second_month, $third_month)
    )
  
ORDER BY NAME, ROW_ORDER, PERIOD_NAME)
) 
  ;
  
  
  SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY,NAME
  FROM "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST";


///




set CY = '2021';
set CQ = 'Q4';
set first_month = 'M10';
set second_month = 'M11';
set third_month = 'M12';

// 

CREATE OR REPLACE TABLE "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
AS
(
  
  SELECT * 
  FROM  "PC_MATILLIONLOADER_DB"."PUBLIC"."TARGET_AE_QUOTAMAPPING_PRODUCTIVITYANALYSIS"
  WHERE  YEAR = '2021' 
    AND  ACTIVE = TRUE
    
);

CREATE OR REPLACE TABLE "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST"
AS
(
SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY,NAME
FROM
(
SELECT * FROM
    
    (
    SELECT NAME, '1' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_quota' as QUOTA_NAME, QUOTA_GOAL, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in (Q1, Q2, Q3, Q4))
    WHERE PERIOD_NAME in ($CQ)
    )
UNION
    (
    SELECT NAME, '3' as ROW_ORDER, SF_ID as "CRM_USER_ID", concat($CY,'_',PERIOD_NAME) as "PERIOD_NAME", 'new_arr_month_quota' as QUOTA_NAME, QUOTA_GOAL Quota_Goal, 'USD' as "CURRENCY"
    FROM "MTL_LOAD_PRE"."PUBLIC"."CLARI_QUOTA_UPLOAD_BASE"
    UNPIVOT(QUOTA_GOAL for PERIOD_NAME in ( M1, M2, M3, M4, M5, M6, M7, M8, M9, M10, M11, M12 ))
    WHERE PERIOD_NAME IN ($first_month, $second_month, $third_month)
    )
  
ORDER BY NAME, ROW_ORDER, PERIOD_NAME)
) 
  ;
  
  
  SELECT CRM_USER_ID, PERIOD_NAME, QUOTA_NAME, QUOTA_GOAL, CURRENCY--,NAME
  FROM "MTL_LOAD_TEST"."PUBLIC"."CLARI_QUOTA_UPLOAD_LAST";
